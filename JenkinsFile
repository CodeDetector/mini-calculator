pipeline {
	agent any 
	
	stages {
		stage('checkout'){
			checkout scm
		}
		stage('Maven Build'){
			sh 'mvn clean install'
		}
		stage('Docker Build Image'){
			sh 'docker build -t dhruvsharma983/docker-push .'
		}
		stage('Publish Docker Images'){
		withCredentials([usernamePassword(credentialsId:'dockerCreds',usernameVariable:'USERNAME',passwordVariable:'PASSWORD')]){
		sh "docker login -u ${env.USERNAME} -p ${env.PASSWORD}"
		sh "docker push dhruvsharma983/docker-push:latest"
		}
		}
		stage('Clean Docker Images'){
		steps {
			sh 'docker rmi -f dhruvsharma983/docker-push'
		}
		}
		stage('Deploy and Run Image'){
		steps {
			annsiblePlaybook becomeUser: null , colorized: true ,disableHostKeyChecking:true , installation: 'Ansible' , inventory: 'inventory' ,playbook:'playbook.yml' , sudoUser: null 
		}
		}
	}
	post {
		always {
			sh 'docker logout'
		}
	}

}
